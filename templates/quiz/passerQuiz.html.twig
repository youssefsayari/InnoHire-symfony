{% extends 'baseFront.html.twig' %}

{% block title %}Passer le Quiz : {{ quiz.getNomQuiz() }}{% endblock %}
{% block navBar %} 
 
                           
                            <a href="{{ path('app_post_front') }}" class="nav-item nav-link  ">
								Home

							</a>
                        
							<a href="{{ path('app_reclamation_indexfront') }}" class="nav-item nav-link">
								Reclamation

							</a>
							
							<a href="{{ path('login') }}" class="nav-link" style="color: red;">
								Logout

							</a>

    

{% endblock %}


{% block etablissement %}
    <div class="container mt-5">
        <h1>Passer le Quiz : {{ quiz.getNomQuiz() }}</h1>
        <div id="countdown">Temps restant : <span id="timer">{{ tempsRestant }}</span> secondes</div>
        <form id="quizForm" action="{{ path('app_passer_quiz', {'id': quiz.getId()}) }}" method="post">
            {% for question in questions %}
                <h3>{{ question.question }}</h3>
                <ul>
                    {% for choix in question.choix|split(',') %}
                        <li>{{ choix }}</li>
                    {% endfor %}
                </ul>
                <label for="reponse_{{ question.getId() }}">Votre réponse :</label>
                <input type="text" id="reponse_{{ question.getId() }}" name="reponse_{{ question.getId() }}" required><br><br>
            {% endfor %}
            <button type="button" class="btn btn-primary" onclick="showPromptBeforePDFGeneration()">Envoyer</button>
            <input type="hidden" name="tempsRestant" value="{{ tempsRestant }}">
            {% if app.session.flashBag.has('error') %}
                <div class="alert alert-danger" role="alert">
                    {{ app.session.flashBag.get('error')[0] }}
                </div>
            {% endif %}
        </form>
    </div>

    <script>
       function showPromptBeforePDFGeneration() {
        alert("Vous trouverez le bilan de votre quiz avec votre score dans un nouvel onglet.");

        // Créer un nouvel objet FormData pour envoyer les données du formulaire
        var formData = new FormData(document.getElementById('quizForm'));

        // Envoyer une requête AJAX pour générer le PDF
        var xhr = new XMLHttpRequest();
        xhr.open("POST", "{{ path('app_passer_quiz', {'id': quiz.getId()}) }}", true);
        xhr.responseType = 'blob'; // Spécifiez le type de réponse comme un objet Blob

        xhr.onreadystatechange = function () {
            if (xhr.readyState === XMLHttpRequest.DONE) {
                if (xhr.status === 200) {
                    // Si la requête a réussi, créer un objet URL pour le contenu du PDF
                    var url = window.URL.createObjectURL(xhr.response);
                    // Ouvrir l'URL dans un nouvel onglet
                    window.open(url, '_blank');
                } else {
                    // Gérer les erreurs de la requête AJAX ici
                    alert("Une erreur s'est produite lors de la génération du PDF.");
                }
            }
        };

        // Envoyer la requête AJAX avec les données du formulaire
        xhr.send(formData);
    }


        var timeLeft = {{ tempsRestant }};
        var timerElement = document.getElementById('timer');
        var form = document.getElementById('quizForm');

        function countdown() {
            if (timeLeft === 0) {
                clearInterval(timer);
                // Mettre à jour la valeur de tempsRestant dans le formulaire
                document.querySelector('input[name="tempsRestant"]').value = 0;
                form.submit();
            } else {
                timerElement.textContent = timeLeft;
                timeLeft--;

                // Afficher la notification lorsque le temps restant est égal à 10 secondes
                if (timeLeft === 10) {
                    showNotification("Il vous reste 10 secondes !");
                }
            }
        }

        var timer = setInterval(countdown, 1000);

        // Fonction pour afficher une notification
        function showNotification(message) {
            // Vérifier si les notifications sont supportées par le navigateur
            if (!("Notification" in window)) {
                alert("Ce navigateur ne prend pas en charge les notifications de bureau.");
            } else if (Notification.permission === "granted") {
                // Si les notifications sont autorisées, afficher la notification
                var notification = new Notification("Dépêchez-vous !", { body: message });
            } else if (Notification.permission !== "denied") {
                // Demander la permission à l'utilisateur s'il ne l'a pas déjà refusée
                Notification.requestPermission().then(function(permission) {
                    if (permission === "granted") {
                        // Si l'utilisateur autorise les notifications, afficher la notification
                        var notification = new Notification("Dépêchez-vous !", { body: message });
                    }
                });
            }
        }
    </script>
{% endblock %}
